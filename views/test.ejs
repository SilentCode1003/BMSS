<script>
    router.post("/save", (req, res) => {
    try {
      let requestby = req.body.requestby;
      let requestdate = req.body.requestdate;
      let details = req.body.details;
      let type = req.body.type;
      let store = req.body.store;
      let status = dictionary.GetValue(dictionary.REQ());
      let master_store_status = dictionary.GetValue(dictionary.ACT());
      let request_equipment_detail = [];
      let remarks = ${store} - ${type};
      let createdby = req.session.fullname;
      let createddate = helper.GetCurrentDatetime();
      let master_store = [];
      let cabling_request_type = [];
      let request_equipment_item = [];
      let sql_exist = `select * from request_equipment_detail 
          where red_requestby='${requestby}' 
          and red_requestdate='${requestdate}' 
          and red_detail='${details}'`;
  
      let jsonDetails = helper.ConvertToJson(JSON.parse(details));
      let requestEquipmentItemModel = jsonDetails.map(
        (data) =>
          new RequestMaterialModel(
            data["brand"],
            data["description"],
            data["count"],
            data["unit"]
          )
      );
  
      //#region STORE
      let check_master_store = select * from master_store where ms_storename='${store}';
      admin.Select(check_master_store, "MasterStore", (err, result) => {
        if (err) console.error("Error: ", err);
  
        if (result.length != 0) {
        } else {
          master_store.push([store, master_store_status, createdby, createddate]);
  
          admin.InsertTable("master_store", master_store, (err, result) => {
            if (err) console.error("Error: ", err);
  
            console.log(${result});
          });
        }
      });
      //#endregion
  
      //#region TYPE
      let check_cabling_request_type = select * from cabling_request_type where crt_typename='${type}';
      mysql.Select(
        check_cabling_request_type,
        "CablingRequestType",
        (err, result) => {
          if (err) console.error("Error: ", err);
  
          if (result.length != 0) {
          } else {
            cabling_request_type.push([
              type,
              master_store_status,
              createdby,
              createddate,
            ]);
  
            mysql.InsertTable(
              "cabling_request_type",
              cabling_request_type,
              (err, result) => {
                if (err) console.error("Error: ", err);
  
                console.log(${result});
              }
            );
          }
        }
      );
      //#endregion
  
      //#region REQUEST
      mysql.Select(sql_exist, "RequestEquipmentDetail", (err, result) => {
        if (err) console.error("Error: ", err);
  
        if (result.length != 0) {
          return res.json({
            msg: "duplicate",
          });
        } else {
          request_equipment_detail.push([
            requestby,
            requestdate,
            details,
            remarks,
            status,
          ]);
  
          console.log(request_equipment_detail);
          mysql.InsertTable(
            "request_equipment_detail",
            request_equipment_detail,
            (err, result) => {
              if (err) console.error("Error: ", err);
              console.log(result);
              let requestid = result[0].id;
  
              requestEquipmentItemModel.forEach((item, index) => {
                request_equipment_item.push([
                  requestid,
                  requestby,
                  requestdate,
                  item.brand,
                  item.description,
                  item.count,
                  item.unit,
                  status,
                  "",
                  "",
                ]);
              });
  
              console.log(request_equipment_item);
              mysql.InsertTable(
                "request_equipment_item",
                request_equipment_item,
                (err, result) => {
                  if (err) console.error("Error: ", err);
                  console.log(result);
  
                  res.json({
                    msg: "success",
                  });
                }
              );
            }
          );
        }
      });
      //#endregion
    } catch (error) {
      res.json({
        msg: error,
      });
    }
  });
</script>